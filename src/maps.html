<!DOCTYPE html>
<html>
	<head>
		<script src="../bower_components/geofire/dist/geofire.min.js"></script>
		<script src="../bower_components/firebase/firebase.js"></script>
		<!--<script src="js/markers.js"></script>-->
		<style>
			#map {
			height: 400px;
			width: 100%;
			}
		</style>
	</head>
		<body>
		<div id="map"></div>

		<form action="">
			<fieldset>
				<legend>Voeg een adres toe</legend>
				<dl>
					<dt><label for="locationName">Naam</label></dt>
					<dd><input type="text" name="locationName" value="" id="locationName"></dd>
					<dt><label for="locationStreet">Straat</label></dt>
					<dd><input type="text" name="locationStreet" id="locationStreet" value=""></dd>
					<dt><label for="locationStreetNumber">Straat nummer</label></dt>
					<dd><input type="text" name="locationStreetNumber" id="locationStreetNumber" value=""></dd>
					<dt><label for="locationCity">Gemeente</label></dt>
					<dd><input type="text" name="locationCity" id="locationCity" value=""></dd>
					<button type="button" id="locationBtn">Add location</button>
				</dl>
			</fieldset>
		</form>

		<script>

			// Initialize the Firebase SDK
			firebase.initializeApp({
				apiKey: 'AIzaSyDHQfVnj8-EI6WHLkXNl1kJzLv4NRH8Bio',
				databaseURL: 'https://bloeddonatie-bd78c.firebaseio.com'
			});

			// Generate a reference to database
			let firebaseRef = firebase.database();

			function initMap() {

				// Initialise map and center it to x location
				let map = new google.maps.Map(document.getElementById('map'), {
					zoom: 14,
					center: { lat: 51.04060 , lng: 3.70976 }
				});
				// Initialise geocoder object
				let geocoder = new google.maps.Geocoder();

				document.getElementById('locationBtn').onclick = function () {
					// Location object
					let name = document.getElementById('locationName').value;
					let street = document.getElementById('locationStreet').value;
					let streetNumber = document.getElementById('locationStreetNumber').value;
					let city = document.getElementById('locationCity').value;
					let isMobile = false;

					addLocation(geocoder, map, name, street, streetNumber, city, isMobile);
				}
			};

			let addLocation = function(geocoder, resultsMap, name, street, streetNumber, city, isMobile) {

				let address = streetNumber + ' ' + street + ', ' + city + ', ' + 'BE';

				geocoder.geocode({'address': address}, function(results, status) {
					if (status === 'OK') {
						resultsMap.setCenter(results[0].geometry.location);

						let lat = results[0].geometry.location.lat();
						let lng = results[0].geometry.location.lng();

						// add location to database
						let itemId = firebaseRef.ref('loacations_test').push().getKey();
						firebaseRef.ref('locations_test').child(itemId).set({
							id: itemId,
							name: name,
							street: street,
							streetNumber: streetNumber,
							city: city,
							isMobile: isMobile,
							lat: lat,
							lng: lng
						});

						// add location to geofire
						let location =  [lat, lng];
						let firebaseRefLocationsGeo = firebase.database().ref('locations_geo_test/' + itemId);
						let geoFire = new GeoFire(firebaseRefLocationsGeo);
						geoFire.set('location', location);
					} else {
						alert('Geocode was not successful for the following reason: ' + status);
					}
				});
			};

			function deleteLocation() {

			};

			function renderMarkers() {
				// Get new location data
				let title = document.getElementById('markerTitle').value;
				let street = document.getElementById('markerStreet').value;
				let streetNumber = document.getElementById('markerStreetNumber').value;
				let city = document.getElementById('markerCity').value;
				let isMobile = false;

				marker = new google.maps.Marker({
					position: latLng,
					map: map
				});

				infoWindow = new google.maps.InfoWindow({
					content: 'This is content for the infoWindow'
				});

				marker.addListener('click', function() {
					infoWindow.open(map, marker);
				});
			};

			// Adds a marker to the map and push to the array.
			function changeMarker(locationObject) {
				marker.setPosition(locationObject);
				let lat = marker.getPosition().lat();
				let lng = marker.getPosition().lng();
				document.getElementById('flat').value = lat;
				document.getElementById('flng').value = lng;
				let locationId = lat.toFixed(7).toString().replace('.', '');
				let location =  [lat, lng];

				let itemId = firebaseRef.ref('loacations_test').push().getKey();
				firebaseRef.ref('locations_test').child(itemId).set({
					title: 'test title',
					address: 'test address'
				});
				let firebaseRefLocationsGeo = firebase.database().ref('locations_test/' + itemId);
				let geoFire = new GeoFire(firebaseRefLocationsGeo);
				geoFire.set('location', location)
			}

		</script>
		<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHQfVnj8-EI6WHLkXNl1kJzLv4NRH8Bio&callback=initMap"></script>
	</body>
</html>
