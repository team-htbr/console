<!DOCTYPE html><html><head>
		<script src="../bower_components/geofire/dist/geofire.min.js"></script>
		<script src="../bower_components/firebase/firebase.js"></script>
		<style>
			#map {
			height: 400px;
			width: 100%;
			}
		</style>
	</head>
		<body>
		<div id="map"></div>
		<form action="">
			<fieldset>
				<legend>Voeg een adres toe</legend>
				<dl>
					<dt><label for="locationName">Naam</label></dt>
					<dd><input type="text" name="locationName" value="" id="locationName"></dd>
					<dt><label for="locationStreet">Straat</label></dt>
					<dd><input type="text" name="locationStreet" id="locationStreet" value=""></dd>
					<dt><label for="locationStreetNumber">Straat nummer</label></dt>
					<dd><input type="text" name="locationStreetNumber" id="locationStreetNumber" value=""></dd>
					<dt><label for="locationCity">Gemeente</label></dt>
					<dd><input type="text" name="locationCity" id="locationCity" value=""></dd>
					<button type="button" id="locationBtn">Add location</button>
				</dl>
			</fieldset>
		</form>

		<script>

			// Initialize the Firebase SDK
			firebase.initializeApp({
				apiKey: 'AIzaSyDHQfVnj8-EI6WHLkXNl1kJzLv4NRH8Bio',
				databaseURL: 'https://bloeddonatie-bd78c.firebaseio.com'
			});

			// Generate a reference to database
			let firebaseRef = firebase.database();

			function initMap() {

				// Initialise map and center it to x location
				let map = new google.maps.Map(document.getElementById('map'), {
					zoom: 14,
					center: { lat: 51.04060 , lng: 3.70976 }
				});
				// Initialise geocoder object
				let geocoder = new google.maps.Geocoder();
				let infoWindow = new google.maps.InfoWindow();

				document.getElementById('locationBtn').onclick = function () {
					// Location object
					let name = document.getElementById('locationName').value;
					let street = document.getElementById('locationStreet').value;
					let streetNumber = document.getElementById('locationStreetNumber').value;
					let city = document.getElementById('locationCity').value;
					let isMobile = false;

					addLocation(geocoder, map, name, street, streetNumber, city, isMobile);
				}

				google.maps.event.addListener(map, 'click', function() {
					infoWindow.close();
				});

				renderMarkers(map, infoWindow);
			};

			let addLocation = function(geocoder, resultsMap, name, street, streetNumber, city, isMobile) {

				let address = streetNumber + ' ' + street + ', ' + city + ', ' + 'BE';

				geocoder.geocode({'address': address}, function(results, status) {
					if (status === 'OK') {
						resultsMap.setCenter(results[0].geometry.location);

						let lat = results[0].geometry.location.lat();
						let lng = results[0].geometry.location.lng();

						// add location to database
						let itemId = firebaseRef.ref('loacations_test').push().getKey();
						firebaseRef.ref('locations_test').child(itemId).set({
							id: itemId,
							name: name,
							street: street,
							streetNumber: streetNumber,
							city: city,
							isMobile: isMobile,
							lat: lat,
							lng: lng
						});

						// add location to geofire
						let location =  [lat, lng];
						let firebaseRefLocationsGeo = firebaseRef.ref('locations_geo_test/' + itemId);
						let geoFire = new GeoFire(firebaseRefLocationsGeo);
						geoFire.set('location', location);
					} else {
						alert('Geocode was not successful for the following reason: ' + status);
					}
				});
			};

			function deleteLocation() {

			};

			function renderMarkers(resultsMap, infoWindow) {
				
				let locations = firebaseRef.ref('locations_test');
				
				locations.on('child_added', function(location) {
					renderMarker(resultsMap, infoWindow, location);
				});

				locations.on('child_removed', function(location) {
					renderMarker(resultsMap, infoWindow, location);
				});

				locations.on('child_changed', function(location) {
					renderMarker(resultsMap, infoWindow, location);
				});

				locations.on('child_moved', function(location) {
					renderMarker(resultsMap, infoWindow, location);
				});
			};

			let renderMarker = function(resultsMap, infoWindow, location) {
				let name = '<h3>' + location.val().name + '</h3>';
				let address = '<p>' + location.val().street + ' ' + location.val().streetNumber + ', ' + location.val().city + '</p>';
				let content = name + address;
				let coordinates = [location.val().lat, location.val().lng];
				console.log(coordinates);

				let marker = new google.maps.Marker({
					position: { lat:  location.val().lat, lng: location.val().lng },
					map: resultsMap
				});

				google.maps.event.addListener(marker, 'click', function() {
					infoWindow.setContent(content);
					infoWindow.open(resultsMap, marker);
				});
			}

			let removeMarker = function(resultsMap, location) {

			}

			// Adds a marker to the map and push to the array.
			function changeMarker(locationObject) {
				marker.setPosition(locationObject);
				let lat = marker.getPosition().lat();
				let lng = marker.getPosition().lng();
				document.getElementById('flat').value = lat;
				document.getElementById('flng').value = lng;
				let locationId = lat.toFixed(7).toString().replace('.', '');
				let location =  [lat, lng];

				let itemId = firebaseRef.ref('loacations_test').push().getKey();
				firebaseRef.ref('locations_test').child(itemId).set({
					title: 'test title',
					address: 'test address'
				});
				let firebaseRefLocationsGeo = firebase.database().ref('locations_test/' + itemId);
				let geoFire = new GeoFire(firebaseRefLocationsGeo);
				geoFire.set('location', location)
			}

		</script>
		<script async="" defer="" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDHQfVnj8-EI6WHLkXNl1kJzLv4NRH8Bio&amp;callback=initMap"></script>
	

</body></html>